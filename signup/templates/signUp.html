{% extends 'layout/base.html' %}

{% block title %}sign up{% endblock %}

{% block body %}

<div class="neuEffectNonHover justify-content-center mx-auto" style="max-width: 85%" id="card">
    <div class="col justify-content-center" style="text-align: center;">
        <form enctype="multipart/form-data" id="sign_up_form" method="POST" action="#">
            {% csrf_token %}
            <div class="row mx-auto" style="max-width: 100%px;">
                <label for="account_type"><h3><strong>Sign Up as</strong></h3></label>
                <strong>
                    <select class="neuEffect text-center input-lg p-3 " onchange="createButton(this)" id="account_type" name="account_type" style="font-weight: bold;" required>
                        <option disabled selected value></option>
                        <option name="Student" value="Student">Student</option>
                        <option name="Teacher" value="Teacher">Teacher</option>
                    </select>
                </strong>
            </div>
            <br>
            <h3><strong>Personal Info</strong></h3>
            <div class="row">
                <div class="col">
                    <label class="mt-3" for="full_name">Full name
                    <input class="neuEffect input-lg ms-3" type="text" id="full_name" name="full_name" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="fathers_name">Father's name
                    <input class="neuEffect input-lg ms-3" type="text" id="fathers_name" name="fathers_name" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="mothers_name">Mother's name
                    <input class="neuEffect input-lg ms-3" type="text" id="mothers_name" name="mothers_name" value="" required></label>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label class="mt-3" for="phone">Phone
                    <input class="neuEffect input-lg" type="text" id="phone" name="phone" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="email">Email
                    <input class="neuEffect input-lg" type="email" id="email" name="email" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="password">Password
                    <input class="neuEffect input-lg" type="password" id="password" name="password" value="" required></label>
                </div>
            </div>

            <div class="row">
                <div class="col">
                    <label class="mt-3" for="gender">Gender
                    <select class="neuEffect input-lg text-center " id="gender" name="gender" required>
                        <option disabled selected value></option>
                        <option name="Male" value="Male">Male</option>
                        <option name="Female" value="Female">Female</option>
                    </select></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="religion">Religion
                    <select class="neuEffect input-lg text-center " id="religion" name="religion" required>
                        <option disabled selected value></option>
                        <option name="Muslim" value="Muslim">Muslim</option>
                        <option name="Christian" value="Christian">Christian</option>
                        <option name="Jewish" value="Jewish">Jewish</option>
                        <option name="Hindu" value="Hindu">Hindu</option>
                    </select></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="blood_group">Blood Group
                    <select class="neuEffect input-lg text-center " id="blood_group" name="blood_group" required>
                        <option disabled selected value></option>
                        <option name="A+" value="A+">A+</option>
                        <option name="B+" value="B+">B+</option>
                        <option name="O+" value="O+">O+</option>
                        <option name="AB+" value="AB+">AB+</option>
                        <option name="AB-" value="AB-">AB-</option>
                        <option name="O-" value="O-">O-</option>
                        <option name="B-" value="B-">B-</option>
                        <option name="A-" value="A-">A-</option>
                    </select></label>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <label class="mt-3" for="gender">Date of Birth
                    <input type="date" id="dob" name="dob" class="neuEffect input-lg text-center"></label>
                </div>
            </div>
            <h3><strong>Address Info</strong></h3>
            <div class="row">
                <div class="col">
                    <label class="mt-3" for="street">Street info
                    <input class="neuEffect input-lg" type="text" id="street" name="street" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="city">City
                    <input class="neuEffect input-lg" type="text" id="city" name="city" value="" required></label>
                </div>
                <div class="col">
                    <label class="mt-3" for="state">State
                    <input class="neuEffect input-lg" type="text" id="state" name="state" value="" required></label>
                </div>
            </div>
            <div class="row justify-content-start">
                <div class="col">
                    <label class="mt-3" for="zip">Zip
                    <input class="neuEffect input-lg w-25" type="text" id="zip" name="zip" value="" required></label>
                </div>
            </div>
            <h3><strong>Photo</strong></h3>
            <div class="row">
                <div class="col">
                    <label class="mt-3" for="profile_photo">Please Upload a photo(jpg, jpeg, png)</label><br>
                    <input class="neuEffect input-lg mx-auto" style="max-width: 25%;" type="file" id="profile_photo" name="profile_photo" value="" required>
                </div>
            </div>
            <br>
            <div class="row">
                <div class="col">
                    <label for="terms_and_condition" class="p-3">
                    <input class="neuEffect mx-auto" style="max-width: 25%;" type="checkbox" id="terms_and_condition" name="terms_and_condition" required> Agree to the terms and condition</label>
                </div>
            </div>
            <div class="row">
                <div class="col">
                    <input class="m-5 btn btn-lg neuEffect" type="submit" value="Sign up as" id="create-acc" style="font-weight: bold;">
                </div>
            </div>
        </form>
    </div>

</div>

    <script>
        $('#home').removeClass('active')
        $('#student_signUp').addClass('active')
        $('#create-acc').prop('disabled', true)

        function createButton(person){
            console.log(person)
            $('#create-acc').attr('value', 'Sign Up as ' + person.value)
            $('#create-acc').prop('disabled', false)
        }

        $('#sign_up_form').submit(function(event){
            event.preventDefault()
            console.log(event)
            let input_data = new FormData(document.getElementById('sign_up_form'));
            let input_image = document.forms["sign_up_form"]["profile_photo"].value;
            console.log(input_image)
            console.log("input data showing")
            console.log(input_data)
            input_image = input_image.split('.')
            if(input_image[input_image.length - 1] == "jpg" || input_image[input_image.length - 1] == "jpeg" || input_image[input_image.length - 1] == "png"){
                console.log("Test")
                $.ajax({
                    type: "POST",
                    headers: {"X-CSRFToken": '{{csrf_token}}'},
                    enctype: 'multipart/form-data',
                    processData: false,
                    async: false,
                    cache: false,
                    contentType: false,
                    url: "http://127.0.0.1:8000/sign_up/sign_up_api/",
                    data: input_data,
                    success: function(data){
                        console.log("checking Api Success")
                        console.log(data)
                        if(data.status == 200){
                            $('#card').html(`
                                <br>
                                <h3 class="mt-3">Please Check Your Mail for verification</h3>
                                <h4 class="m-5"> NOTE : Please Check SPAM folder of your mail In case if It's got recognise as spam</h3>
                            `)

                            localStorage.removeItem('localEmail')
                            localStorage.removeItem('account_type')
                            window.location = "/sign_in/"
                        }
                        else if(data.status == 208){
                            $('#card').html(`
                                <br>
                                <h3 class="mt-3">No Need to Sign Up!<br>An account Found with this Email</h3>
                                <h4 class="m-5"> You can directly Sign In</h3>
                                <a class="btn btn-lg neuEffect" href="/sign_in/">Sign In Page</a>
                            `)
                            localStorage.removeItem('localEmail')
                            localStorage.removeItem('account_type')
                        }
                        else if(data.status == 401){
                            $('#card').html(`
                                <br>
                                <h3 class="mt-3">Heads Up!<br>An Unactivated account Found with this Email</h3>
                                <h4 class="m-5"> You can verify now</h3>
                                <button class="btn btn-lg neuEffect" onclick="send_verification_link(${ data.email })" id="verification_link">Send verification link</button>
                            `)
                            //$('#verification_link').attr('onclick', `onclick="send_verification_link(${localStorage.getItem('localEmail')},${localStorage.getItem('account_type')})`)
                        }
                    },
                    error: function(data){
                        console.log("checking Error")
                        console.log(data)
                    }
                });
            }
        })

        function send_verification_link(){
            input_data = {}
            input_data['email'] = localStorage.getItem('localEmail')
            input_data['account_type'] = localStorage.getItem('account_type')

            console.log("webpage data")
            console.log(input_data)

            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8000/sign_up/send_verification_api/",
                data: JSON.stringify(input_data),
                headers: {"X-CSRFToken": '{{csrf_token}}'},
                success: function(data){
                    console.log("checking Api Success")
                    console.log(data)
                    if(data.status == 200){
                        console.log("Success")
                        console.log(data)
                    }

                },
                error: function(data){
                    console.log("checking Error")
                    console.log(data)
                }
            });
            localStorage.removeItem('account_type')
        }

    </script>

{% endblock %}